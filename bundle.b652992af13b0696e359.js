(()=>{var t={484:function(t){t.exports=function(){"use strict";var t=6e4,e=36e5,s="millisecond",i="second",r="minute",n="hour",a="day",h="week",l="month",o="quarter",c="year",d="date",u="Invalid Date",m=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,g=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,f={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var e=["th","st","nd","rd"],s=t%100;return"["+t+(e[(s-20)%10]||e[s]||e[0])+"]"}},p=function(t,e,s){var i=String(t);return!i||i.length>=e?t:""+Array(e+1-i.length).join(s)+t},S={s:p,z:function(t){var e=-t.utcOffset(),s=Math.abs(e),i=Math.floor(s/60),r=s%60;return(e<=0?"+":"-")+p(i,2,"0")+":"+p(r,2,"0")},m:function t(e,s){if(e.date()<s.date())return-t(s,e);var i=12*(s.year()-e.year())+(s.month()-e.month()),r=e.clone().add(i,l),n=s-r<0,a=e.clone().add(i+(n?-1:1),l);return+(-(i+(s-r)/(n?r-a:a-r))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:l,y:c,w:h,d:a,D:d,h:n,m:r,s:i,ms:s,Q:o}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},b="en",y={};y[b]=f;var C=function(t){return t instanceof k},w=function t(e,s,i){var r;if(!e)return b;if("string"==typeof e){var n=e.toLowerCase();y[n]&&(r=n),s&&(y[n]=s,r=n);var a=e.split("-");if(!r&&a.length>1)return t(a[0])}else{var h=e.name;y[h]=e,r=h}return!i&&r&&(b=r),r||!i&&b},$=function(t,e){if(C(t))return t.clone();var s="object"==typeof e?e:{};return s.date=t,s.args=arguments,new k(s)},v=S;v.l=w,v.i=C,v.w=function(t,e){return $(t,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var k=function(){function f(t){this.$L=w(t.locale,null,!0),this.parse(t)}var p=f.prototype;return p.parse=function(t){this.$d=function(t){var e=t.date,s=t.utc;if(null===e)return new Date(NaN);if(v.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var i=e.match(m);if(i){var r=i[2]-1||0,n=(i[7]||"0").substring(0,3);return s?new Date(Date.UTC(i[1],r,i[3]||1,i[4]||0,i[5]||0,i[6]||0,n)):new Date(i[1],r,i[3]||1,i[4]||0,i[5]||0,i[6]||0,n)}}return new Date(e)}(t),this.$x=t.x||{},this.init()},p.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},p.$utils=function(){return v},p.isValid=function(){return!(this.$d.toString()===u)},p.isSame=function(t,e){var s=$(t);return this.startOf(e)<=s&&s<=this.endOf(e)},p.isAfter=function(t,e){return $(t)<this.startOf(e)},p.isBefore=function(t,e){return this.endOf(e)<$(t)},p.$g=function(t,e,s){return v.u(t)?this[e]:this.set(s,t)},p.unix=function(){return Math.floor(this.valueOf()/1e3)},p.valueOf=function(){return this.$d.getTime()},p.startOf=function(t,e){var s=this,o=!!v.u(e)||e,u=v.p(t),m=function(t,e){var i=v.w(s.$u?Date.UTC(s.$y,e,t):new Date(s.$y,e,t),s);return o?i:i.endOf(a)},g=function(t,e){return v.w(s.toDate()[t].apply(s.toDate("s"),(o?[0,0,0,0]:[23,59,59,999]).slice(e)),s)},f=this.$W,p=this.$M,S=this.$D,b="set"+(this.$u?"UTC":"");switch(u){case c:return o?m(1,0):m(31,11);case l:return o?m(1,p):m(0,p+1);case h:var y=this.$locale().weekStart||0,C=(f<y?f+7:f)-y;return m(o?S-C:S+(6-C),p);case a:case d:return g(b+"Hours",0);case n:return g(b+"Minutes",1);case r:return g(b+"Seconds",2);case i:return g(b+"Milliseconds",3);default:return this.clone()}},p.endOf=function(t){return this.startOf(t,!1)},p.$set=function(t,e){var h,o=v.p(t),u="set"+(this.$u?"UTC":""),m=(h={},h[a]=u+"Date",h[d]=u+"Date",h[l]=u+"Month",h[c]=u+"FullYear",h[n]=u+"Hours",h[r]=u+"Minutes",h[i]=u+"Seconds",h[s]=u+"Milliseconds",h)[o],g=o===a?this.$D+(e-this.$W):e;if(o===l||o===c){var f=this.clone().set(d,1);f.$d[m](g),f.init(),this.$d=f.set(d,Math.min(this.$D,f.daysInMonth())).$d}else m&&this.$d[m](g);return this.init(),this},p.set=function(t,e){return this.clone().$set(t,e)},p.get=function(t){return this[v.p(t)]()},p.add=function(s,o){var d,u=this;s=Number(s);var m=v.p(o),g=function(t){var e=$(u);return v.w(e.date(e.date()+Math.round(t*s)),u)};if(m===l)return this.set(l,this.$M+s);if(m===c)return this.set(c,this.$y+s);if(m===a)return g(1);if(m===h)return g(7);var f=(d={},d[r]=t,d[n]=e,d[i]=1e3,d)[m]||1,p=this.$d.getTime()+s*f;return v.w(p,this)},p.subtract=function(t,e){return this.add(-1*t,e)},p.format=function(t){var e=this,s=this.$locale();if(!this.isValid())return s.invalidDate||u;var i=t||"YYYY-MM-DDTHH:mm:ssZ",r=v.z(this),n=this.$H,a=this.$m,h=this.$M,l=s.weekdays,o=s.months,c=function(t,s,r,n){return t&&(t[s]||t(e,i))||r[s].slice(0,n)},d=function(t){return v.s(n%12||12,t,"0")},m=s.meridiem||function(t,e,s){var i=t<12?"AM":"PM";return s?i.toLowerCase():i},f={YY:String(this.$y).slice(-2),YYYY:this.$y,M:h+1,MM:v.s(h+1,2,"0"),MMM:c(s.monthsShort,h,o,3),MMMM:c(o,h),D:this.$D,DD:v.s(this.$D,2,"0"),d:String(this.$W),dd:c(s.weekdaysMin,this.$W,l,2),ddd:c(s.weekdaysShort,this.$W,l,3),dddd:l[this.$W],H:String(n),HH:v.s(n,2,"0"),h:d(1),hh:d(2),a:m(n,a,!0),A:m(n,a,!1),m:String(a),mm:v.s(a,2,"0"),s:String(this.$s),ss:v.s(this.$s,2,"0"),SSS:v.s(this.$ms,3,"0"),Z:r};return i.replace(g,(function(t,e){return e||f[t]||r.replace(":","")}))},p.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},p.diff=function(s,d,u){var m,g=v.p(d),f=$(s),p=(f.utcOffset()-this.utcOffset())*t,S=this-f,b=v.m(this,f);return b=(m={},m[c]=b/12,m[l]=b,m[o]=b/3,m[h]=(S-p)/6048e5,m[a]=(S-p)/864e5,m[n]=S/e,m[r]=S/t,m[i]=S/1e3,m)[g]||S,u?b:v.a(b)},p.daysInMonth=function(){return this.endOf(l).$D},p.$locale=function(){return y[this.$L]},p.locale=function(t,e){if(!t)return this.$L;var s=this.clone(),i=w(t,e,!0);return i&&(s.$L=i),s},p.clone=function(){return v.w(this.$d,this)},p.toDate=function(){return new Date(this.valueOf())},p.toJSON=function(){return this.isValid()?this.toISOString():null},p.toISOString=function(){return this.$d.toISOString()},p.toString=function(){return this.$d.toUTCString()},f}(),D=k.prototype;return $.prototype=D,[["$ms",s],["$s",i],["$m",r],["$H",n],["$W",a],["$M",l],["$y",c],["$D",d]].forEach((function(t){D[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),$.extend=function(t,e){return t.$i||(t(e,k,$),t.$i=!0),$},$.locale=w,$.isDayjs=C,$.unix=function(t){return $(1e3*t)},$.en=y[b],$.Ls=y,$.p={},$}()},997:function(t){t.exports=function(){"use strict";return function(t,e,s){e.prototype.dayOfYear=function(t){var e=Math.round((s(this).startOf("day")-s(this).startOf("year"))/864e5)+1;return null==t?e:this.add(t-e,"day")}}}()},837:function(t,e,s){"use strict";var i;i=(i=function(){const t=void 0!==this.window?window.fetch:s(300);let e;class i{constructor(t,e){this.id=t,this.access_token=e}_fetchParams(t){t=t||{};const e={headers:{Accept:"application/json"}};return this.access_token&&(e.headers.Authorization=`Bearer ${this.access_token}`),t.type&&(e.headers["Content-Type"]=t.type),e}async get(s){return t(`${e.BASE_URL}/${this.id}/${s}`,this._fetchParams()).then(r).then((t=>t.text()))}async set(s,i,n){return t(`${e.BASE_URL}/${this.id}/${s}`,{...this._fetchParams(n),method:"PUT",body:i}).then(r).then((t=>t.text()))}async incr(s,i){return i>0&&(i="+"+i),t(`${e.BASE_URL}/${this.id}/${s}`,{...this._fetchParams(),method:"PATCH",body:i}).then(r).then((t=>t.text()))}async delete(s){return t(`${e.BASE_URL}/${this.id}/${s}`,{...this._fetchParams(),method:"DELETE"}).then((t=>t.text()))}async list(s){s=s||{};const i=new URLSearchParams;return s.skip&&i.append("skip",s.skip),s.limit&&i.append("limit",s.limit),s.prefix&&i.append("prefix",s.prefix),s.reverse&&i.append("reverse","true"),s.values&&i.append("values","true"),i.append("format","json"),t(`${e.BASE_URL}/${this.id}/?${i.toString()}`,this._fetchParams()).then(r).then((t=>t.json()))}async accessToken(s){s=s||{};const i=new URLSearchParams;return s.prefix&&i.append("prefix",s.prefix),s.permissions&&s.permissions instanceof Array&&i.append("permissions",s.permissions.join(",")),s.ttl&&i.append("ttl",s.ttl),t(`${e.BASE_URL}/${this.id}/tokens/`,{...this._fetchParams({type:"application/x-www-form-urlencoded"}),method:"POST",body:i.toString()}).then(r).then((t=>t.json())).then((t=>t.access_token))}localStorage(t){return new n(this)}}function r(t){if(t.ok)return t;throw Error(`${t.status} - ${t.statusText}`)}class n{constructor(t){this.bucket=t}async key(t){return this.bucket.list({skip:t,limit:1}).then((t=>t)).catch((t=>null))}async getItem(t){return this.bucket.get(t).then((t=>t)).catch((t=>null))}async setItem(t,e){return this.bucket.set(t,e)}async removeItem(t){return this.bucket.delete(t)}async length(){return this.bucket.list().then((t=>t.length)).catch((t=>-1))}async clear(){const t=(await this.bucket.list()).map((t=>this.bucket.delete(t)));return Promise.all(t)}}function a(t,e){e&&t.then((function(t){e(null,t)}),(function(t){e(t)}))}let h={};return e={BASE_URL:"https://kvdb.io",LOCALFORAGE_DRIVER:"localForageDriver",bucket:(t,e)=>new i(t,e),Bucket:i,WebStorage:n,installLocalForageDriver:function(t){return h={_driver:e.LOCALFORAGE_DRIVER,_support:!0,_initStorage:function(e){this.bucket=e.bucket;var s={};return s.serializer=t.getSerializer(),this._dbInfo=s,Promise.resolve()},async clear(t){const e=this._config.bucket,s=e.list().then((t=>t.map((t=>e.delete(t))))).then((t=>Promise.all(t)));return a(s,t),s},async getItem(t,e){const s=this._config.bucket,i=this._dbInfo,r=Promise.all([s.get(t),i.serializer]).then((([t,e])=>e.deserialize(t)));return a(r,e),r},async iterate(t,e){const s=this._config.bucket,i=this._dbInfo,r=Promise.all([s.list({values:!0}),i.serializer]).then((([t,e])=>t.map((([t,s])=>[t,e.deserialize(s)])))).then((e=>{let s=1;for(let[i,r]of e){const e=t(r,i,s++);if(void 0!==e)return e}}));return a(r,e),r},async key(t,e){const s=this._config.bucket,i=this._dbInfo,r=Promise.all([s.list({skip:index,limit:1}),i.serializer]).then((([t,e])=>e.deserialize(t)));return a(r,e),r},async keys(t){const e=this._config.bucket.list().then((t=>t));return a(e,t),e},async length(t){const e=this._config.bucket.list().then((t=>t.length));return a(e,t),e},async removeItem(t,e){const s=this._config.bucket.delete(t);return a(s,e),s},async setItem(t,e,s){const i=this._config.bucket,r=this._dbInfo,n=e,h=r.serializer.then((t=>new Promise(((s,i)=>{t.serialize(e,((t,e)=>e?i(e):s(t)))})))).then((e=>i.set(t,e,{type:"application/json"}))).then((()=>n));return a(h,s),h}},t.defineDriver(h),h}},e}).bind(this),t.exports=i()},300:(t,e,s)=>{"use strict";var i=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==s.g)return s.g;throw new Error("unable to locate global object")}();t.exports=e=i.fetch,i.fetch&&(e.default=i.fetch.bind(i)),e.Headers=i.Headers,e.Request=i.Request,e.Response=i.Response}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var n=e[i]={exports:{}};return t[i].call(n.exports,n,n.exports,s),n.exports}s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";var t=s(484),e=s.n(t);class i{static gEl(t){let e=t;return"string"==typeof t&&(e=document.getElementById(t)),HTMLElement,e}static addListener(t,e,s){i.gEl(t).addEventListener(e,s)}static toggleAllCarets(){let t=document.getElementsByClassName("caret"),e=i.gEl("grp_All");e.classList.toggle("caret-down");let s=e.classList.contains("caret-down");for(let i of t)if(i!=e){let t=i.parentElement.querySelector(".nested");s?(i.classList.contains("caret-down")||i.classList.add("caret-down"),t.classList.contains("active")||t.classList.add("active")):(i.classList.contains("caret-down")&&i.classList.remove("caret-down"),t.classList.contains("active")&&t.classList.remove("active"))}}static toggleList(t){let e=t.target;!e||e.classList.contains("caret"),e.parentElement.querySelector(".nested").classList.toggle("active"),e.classList.toggle("caret-down")}static popup(t){let e=i.gEl("Popup");e.innerHTML=t+'<button id="popupClose"> close </button>',e.className="",i.addListener("popupClose","click",(()=>{i.setClass("Popup","hide",!0)}))}static newEl(t,e,s,i){null==t&&(t="div"),null==e&&(e=""),null==s&&(s=""),null==i&&(i="");let r=document.createElement(t);return""!=e&&(r.id=e),""!=s&&(r.className=s),r.innerText=i,r}static newSel(t,e,s){let r=i.newEl("select",t);for(let t of e){let e=i.newOpt(t);t==s&&(e.selected=!0),r.appendChild(e)}return r}static newOpt(t){let e=i.newEl("option","","",t);return e.value=t,e}static hasClass(t,e){if(t=i.gEl(t),e instanceof Array){for(let s of e)if(t.classList.contains(s))return!0;return!1}return t.classList.contains(e)}static setClass(t,e,s){if(t=i.gEl(t),e instanceof Array){for(let r of e)i.setClass(t,r,s);return}let r=t.classList.contains(e);null==s&&(s=!r),r?s||t.classList.remove(e):s&&t.classList.add(e)}static toggleSel(t){t.classList.toggle("sel")}static loadSelect(t,e){var s;for(s=(t=i.gEl(t)).options.length-1;s>=0;s--)t.remove(s);for(var r of e){var n=document.createElement("option");n.value=n.innerHTML=r,t.appendChild(n)}t.selectedIndex=0}static setExt(t,e){return(t=i.baseNm(t))+e}static baseNm(t){let e=t.indexOf(".");return e>=0&&(t=t.substring(0,e)),t}static isName(t){return null!=t.match(/^\w+[\d\w]*$/i)}static isNumber(t){return null!=t.match(/^-*\d*\.?\d+$/i)}static getDate(){return e()().format("D-MMM-YY H:mm")}static S(t){let e=t.toString(),s=e.indexOf(".");return 1==s&&"0"==e.substring(0,1)&&(e=e.substring(1)),s<0?e:e.substring(0,4)}}class r{static guiCnt=0;constructor(t,e,s,n){this.level=0,this.idcnt=0,this.parId=t,this.par=i.gEl(t),null==this.par&&a(`GUI: element ${t} not found`),this.nm=s||"G";let h=`guiG${r.guiCnt}`;this.id=`gui${r.guiCnt}`,r.guiCnt++;let l=i.newEl("span",h,"gui_group","");this.grpnm=i.newEl("span","","gui_grpnm caret",this.nm),this.bdy=i.newEl("span",this.id,"gui_body",""),l.appendChild(this.grpnm),l.appendChild(this.bdy),this.par.appendChild(l),this.grpnm.addEventListener("click",(t=>{this.setHidden()})),this.setHidden(null!=n&&n),this.items=[]}nxtId(){return this.idcnt++,`${this.id}_${this.idcnt}`}clearGroup(){this.bdy.innerHTML="",this.items=[]}setHidden(t){this.hidden=void 0===t?!this.hidden:t,this.bdy.hidden=this.hidden,i.setClass(this.grpnm,"caret-down",!this.hidden),this.bdy.hidden||"function"!=typeof this.openFn||this.openFn(this.grpnm)}addGroup(t,e,s,n){let a=new r(this.id,t,e,s);return a.level=this.level+1,i.setClass(a.grpnm,`glev${a.level}`,!0),this.addItem("","gui",t,a,!0),s&&a.setHidden(s),a.openFn=n,a}resetGroup(t,e,s,i,r){return null==t&&(this.addBreak(),t=this.addGroup(e,s,i,r)),t.clearGroup(),t}addBreak(){this.bdy.appendChild(document.createElement("br"))}findItm(t){for(let e of this.items)if(e.nm==t)return e;return null}getVal(t){let e=this.findItm(t);if(null==e)return null;let s=i.gEl(e.id);switch(e.typ){case"checkbox":return s.checked;case"div":return s.innerText;default:return s.value}}setVal(t,e){let s=this.findItm(t);if(null==s)return;let r=i.gEl(s.id);switch(s.typ){case"checkbox":r.checked=e;break;case"div":r.innerText=e;break;case"file":r.parentElement.innerText=e;break;default:r.value=e}}showVal(t,e){let s=this.findItm(t);if(null==s)return;let r=i.gEl(s.id);"LABEL"==r.parentElement.tagName&&(r=r.parentElement),r.hidden=null==e?!r.hidden:e}addItem(t,e,s,r){let n=this.nxtId(),a=t;""==a&&(a=s);let h={nm:a,lbl:t,typ:e,str:s,id:n};"function"==typeof r&&(h.fn=r),this.items.push(h);let l="gui",o=null;switch(e){case"sel":o=i.newSel(h.id,s);break;case"gui":h.gui=r,o=h.gui.bdy,n=o.id;break;case"div":o=i.newEl("span",n,"gui guival",s);break;case"checkbox":case"file":l+=" guibx";case"number":case"button":case"text":o=i.newEl("input",n,"gui"),o.type=e,o.value=s}if(""!=t){let e=i.newEl("label","",l,t);e.appendChild(o),o=e}return this.bdy.appendChild(o),n}addSelector(t,e,s){let r=this.addItem(t,"sel",e,s);return"function"==typeof s&&i.addListener(r,"change",(t=>{s(t.target.value)})),r}addLine(t,e,s){let r=this.addItem(t,"div",e,s);return"function"==typeof s&&i.addListener(r,"click",s),r}addCategory(t,e,s,r){let n=this.addItem(t,"checkbox","",s);i.gEl(n).parentElement.className+=" br "+e,"function"==typeof s&&i.addListener(n,"click",s)}addCheckbox(t,e){let s=this.addItem(t,"checkbox","",e);return"function"==typeof e&&i.addListener(s,"click",e),s}addButton(t,e){let s=this.addItem("","button",t,e);return"function"==typeof e&&i.addListener(s,"click",e),s}addNumber(t,e,s){let r=this.addItem(t,"number",e,s);return"function"==typeof s&&i.addListener(r,"click",s),r}addValue(t,e){return this.addItem(t,"div",e)}addText(t,e,s){let r=this.addItem(t,"text",e,s);return"function"==typeof s&&i.addListener(r,"change",(t=>{s(t.target.value)})),r}addFile(t,e,s){let r=this.addItem(t,"file","",s),n=i.gEl(r);return""!=e&&(n.accept=e),"function"==typeof s&&i.addListener(r,"change",(t=>{s(t.target.files)})),r}}function n(t,e){let s=document.getElementById("info");s?s.innerHTML=e?s.innerHTML+t:t:a(t)}function a(t){console.log(t),function({id:t="dlg",cls:e="dlg",title:s="",detail:r="",buttons:n=["Cancel","Confirm"],defaultId:a=0}={}){let h=i.newEl("dialog",t,e,"");h.returnValue=n[a],h.appendChild(i.newEl("div","","",s));let l=i.newEl("form");l.method="dialog",l.appendChild(i.newEl("div","","",r));let o=i.newEl("div"),c=[];for(let t of n){let e=i.newEl("button","","",t);"Confirm"==t&&(e.type="submit"),"Cancel"==t&&(e.type="reset"),o.appendChild(e),c.push({button:e,value:t})}l.appendChild(o),h.appendChild(l),document.body.appendChild(h);for(let t of c)t.button.addEventListener("click",(()=>{h.returnValue=t.value}));h.showModal(),h.returnValue}({title:"Error:",detail:t,type:"error",buttons:["cancel","debug"],defaultId:0})}var h=s(997),l=s.n(h),o=function(t,e){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])},o(t,e)};function c(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function s(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}var d,u=function(){function t(){}return t._xfnv1a=function(t){for(var e=2166136261,s=0;s<t.length;s++)e=Math.imul(e^t.charCodeAt(s),16777619);return function(){return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,(e+=e<<5)>>>0}},t}(),m=function(t){function e(s){var i=t.call(this)||this;return i.a=e._xfnv1a(s)(),i}return c(e,t),e.prototype.next=function(){var t=this.a+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296},e}(u),g=function(t){function e(s){var i=t.call(this)||this,r=e._xfnv1a(s);return i.a=r(),i.b=r(),i.c=r(),i.d=r(),i}return c(e,t),e.prototype.next=function(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;var t=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,t=t+this.d|0,this.c=this.c+t|0,(t>>>0)/4294967296},e}(u),f=function(t){function e(s){var i=t.call(this)||this,r=e._xfnv1a(s);return i.a=r(),i.b=r(),i.c=r(),i.d=r(),i}return c(e,t),e.prototype.next=function(){var t=this.b<<9,e=5*this.a;return e=e<<7|9*(e>>>25),this.c^=this.a,this.d^=this.b,this.b^=this.c,this.a^=this.d,this.c^=t,this.d=this.d<<11|this.d>>>21,(e>>>0)/4294967296},e}(u);!function(t){t.sfc32="sfc32",t.mulberry32="mulberry32",t.xoshiro128ss="xoshiro128ss"}(d||(d={}));var p=function(){function t(t,e){void 0===e&&(e=d.sfc32),this.str=t,this.prng=e,this.generator=this._initializeGenerator()}return t.prototype.next=function(){return this.generator.next()},t.prototype._initializeGenerator=function(){if(function(t){return null===t}(t=this.str)||function(t){return void 0===t}(t))return this.wrap();var t;switch(this.prng){case"sfc32":return new g(this.str);case"mulberry32":return new m(this.str);case"xoshiro128ss":return new f(this.str);default:return this.wrap()}},t.prototype.wrap=function(){return{next:function(){return Math.random()}}},t}(),S=s(837);class b{constructor(t){this.title=t;let s=i.gEl("title");s&&(s.innerText=this.title),this.Version="1.0_5/28/23",e().extend(l()),this.registerSW(),null==Number(localStorage.getItem("nGames"))&&localStorage.setItem("nGames",0),this.UserName=localStorage.getItem("user"),null==this.UserName&&(this.UserName=""),b.currApp=this,this.initMenu(),this.maxunwinnable=3e4,this.bucketKey="XuwVGZhBjT5dPVZGhsTLKG",this.writeKey="7z!FkVC&5KD6",this.initDB(),this.categories={E:"Easy",M:"Medium",H:"Hard",X:"Expert",D:"Daily"},this.initGridEncoder(),this.errCnt=0,this.initListeners(),n(this.title),this.showHelp()}initListeners(){i.addListener("btnE","click",(t=>this.nextGame("E"))),i.addListener("btnM","click",(t=>this.nextGame("M"))),i.addListener("btnH","click",(t=>this.nextGame("H"))),i.addListener("btnX","click",(t=>this.nextGame("X"))),i.addListener("btnD","click",(t=>this.nextGame("D"))),i.addListener("btnHint","click",(t=>this.genHint())),i.addListener("btnQuit","click",(t=>this.quitGame())),i.addListener("btnHelp","click",(t=>this.showHelp())),i.addListener("btnES","click",(t=>this.showStats("E"))),i.addListener("btnMS","click",(t=>this.showStats("M"))),i.addListener("btnHS","click",(t=>this.showStats("H"))),i.addListener("btnXS","click",(t=>this.showStats("X"))),i.addListener("btnDS","click",(t=>this.showStats("D"))),i.addListener("btnR","click",(t=>this.showRecords())),i.addListener("btnNewH","click",(t=>this.showMenu(t))),i.addListener("btnNewC","click",(t=>this.showMenu(t))),i.addListener("btnNewUR","click",(t=>this.showMenu(t))),i.addListener("btnNewCat","click",(t=>this.showMenu(t)));let t=i.gEl("lower");t.addEventListener("contextmenu",(t=>t.preventDefault())),t.addEventListener("mouseup",(t=>{this.gridClick(t)})),t.addEventListener("touchstart",(t=>{this.touchstart(t)}),{passive:!1}),t.addEventListener("touchend",(t=>{this.touchend(t)}),{passive:!1}),t.addEventListener("touchmove",(t=>{this.touchmove(t)}),{passive:!1}),document.addEventListener("keydown",(t=>{this.keydown(t)})),window.addEventListener("resize",(t=>{this.resizeApp()})),document.addEventListener("click",(t=>{i.setClass("Popup","hide",!0)}))}initGridEncoder(){this.gridEncode="abcdefghijmnopqrstuvABCDEFGHIJMNOPQRSTUV",this.decodeGridVal={a:-1,b:0,c:1,d:2,e:3,f:4,g:5,h:6,i:7,j:8,m:-1,n:0,o:1,p:2,q:3,r:4,s:5,t:6,u:7,v:8,A:-1,B:0,C:1,D:2,E:3,F:4,G:5,H:6,I:7,J:8,M:-1,N:0,O:1,P:2,Q:3,R:4,S:5,T:6,U:7,V:8},this.decodeQuest={a:0,b:0,c:0,d:0,e:0,f:0,g:0,h:0,i:0,j:0,m:1,n:1,o:1,p:1,q:1,r:1,s:1,t:1,u:1,v:1,A:0,B:0,C:0,D:0,E:0,F:0,G:0,H:0,I:0,J:0,M:1,N:1,O:1,P:1,Q:1,R:1,S:1,T:1,U:1,V:1},this.decodeSecret={a:0,b:0,c:0,d:0,e:0,f:0,g:0,h:0,i:0,j:0,m:0,n:0,o:0,p:0,q:0,r:0,s:0,t:0,u:0,v:0,A:1,B:1,C:1,D:1,E:1,F:1,G:1,H:1,I:1,J:1,M:1,N:1,O:1,P:1,Q:1,R:1,S:1,T:1,U:1,V:1}}initMenu(){this.gui=new r("header","hdr","_",!0),this.gui.addBreak(),this.gui.addButton("Stats",(t=>this.showGames(t))),this.gui.addButton("Autoplay",(t=>this.play(10))),this.gui.addNumber("X",20),this.gui.addNumber("Y",20),this.gui.addNumber("Mine%",20),this.det=this.gui.addGroup("Details","Det",!0),this.det.addValue("Details:",0),this.mng=this.gui.addGroup("Manage","Mng",!0),this.mng.addNumber("GmStart",0),this.mng.addNumber("Batch",100),this.mng.addButton("Save",(t=>this.findWinnable(t))),this.dbg=this.gui.addGroup("Debug","Dbg",!0),this.dbg.addNumber("zm:",0,this.updatePos.bind(this)),this.dbg.addNumber("dx:",0,this.updatePos.bind(this)),this.dbg.addNumber("dy:",0,this.updatePos.bind(this)),this.dbg.addButton("Colors",(()=>this.chooseColor())),this.dbg.addCheckbox("TM"),this.dbg.addButton("UnPlay",(t=>this.unplayLast(t))),this.dbg.addCheckbox("PropExp"),this.dbg.addButton("Quest",(t=>this.calcQuest(t))),this.dbg.addButton("Eval",(t=>this.findWinnable())),this.dbg.addNumber("mxG",50),i.setClass("guiG0","hide",!0)}showPanels(t,e){n("");for(let e of["Playing","Completed","CatStats","UserRecords"])i.setClass(e,"hide",e!=t);for(let t of["data","menu","help"])i.setClass(t,"hide",t!=e)}registerSW(){"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/service-worker.js").then((t=>{console.log("SW registered: ",t)})).catch((t=>{console.log("SW registration failed: ",t)}))}))}resizeApp(){this.windowW=window.innerWidth,this.windowH=window.innerHeight,this.headerH=i.gEl("header").clientHeight}async initDB(){if(this.bucket=new S.Bucket(this.bucketKey),this.userID=localStorage.getItem("UserID"),null==this.userID){let t=await this.getDBObj("nextUserID",1);this.userID=`U${this.pad4(t)}`,this.bucket.set("nextUserID",Number(t)+1),localStorage.setItem("UserID",this.userID)}if(this.userRecords=await this.getDBObj(this.userID,{numFirsts:0,numBests:0}),this.maxGms=await this.getDBObj("maxGms",{E:0,M:0,H:0,X:0,seed:0}),this.mng.setVal("GmStart",this.maxGms.seed),null==this.UserStats){let t=localStorage.getItem("UserStats");null!=t&&t.startsWith("{")?this.UserStats=JSON.parse(t):(this.UserStats={userID:this.userID,gamesStarted:0,E:{cCnt:0,pCnt:0,cStrk:0,pStrk:0},M:{cCnt:0,pCnt:0,cStrk:0,pStrk:0},H:{cCnt:0,pCnt:0,cStrk:0,pStrk:0},X:{cCnt:0,pCnt:0,cStrk:0,pStrk:0},D:{cCnt:0,pCnt:0,cStrk:0,pStrk:0}},localStorage.setItem("UserStats",JSON.stringify(this.UserStats)))}this.UserStats.userID!=this.userID&&(this.UserStats.userID=this.userID,localStorage.setItem("UserStats",JSON.stringify(this.UserStats))),this.initDaily()}initDaily(){let t=new p(e()().get("year")),s=[],i=this.maxGms.E,r=this.maxGms.M,n=this.maxGms.H,a=this.maxGms.X;r>i/2&&(r=i/2),n>i/3&&(n=i/3),a>i/4&&(a=i/4);for(let t=0;t<i;t++)s.push(`E${this.pad4(t)}`);for(let t=0;t<r;t++)s.push(`M${this.pad4(t)}`);for(let t=0;t<n;t++)s.push(`H${this.pad4(t)}`);for(let t=0;t<a;t++)s.push(`X${this.pad4(t)}`);for(;s.length<366;)s=s.concat(s);this.Daily=[];for(let e=0;e<366;e++){let e=Math.trunc(t.next()*s.length),i=s[e];s.splice(e,1),this.Daily.push(i)}}updateUser(t){if(this.UserName=t,localStorage.setItem("user",t),this.gameisover){let t=localStorage.getItem("nGames")-1,e=localStorage.getItem(`G${t}`);try{let s=JSON.parse(e);s.unm=this.UserName,localStorage.setItem(`G${t}`,JSON.stringify(s))}catch{console.log("error parsing game")}}}initRand(t){this.randgen=new p(t)}rand(){return this.randgen.next()}pad4(t){return t.toString().padStart(4,"0")}pad2(t){return t.toString().padStart(2,"0")}err(t){n(t),console.log(t)}clip(t,e,s){return t<e?e:t>s?s:t}clipY(t){return this.clip(t,0,this.YSize-1)}clipX(t){return this.clip(t,0,this.XSize-1)}resetGrid(){this.grid=[],this.grid[-1]=[],this.grid[this.YSize]=[],this.errCnt=0,this.gameisover=!1,this.gamesteps=[],this.blanks=[],this.processed=[],this.safeClicks=[],this.secret=0,this.cleared=0,this.exploded=0,this.bombed=0,this.marked=0,this.freed=0,this.mines=0,this.wrong=0,this.right=0}initCurrGame(){this.game={ver:this.Version,name:this.gameName,errors:0,hints:0,nseconds:0},this.startClock()}startClock(){this.game.nseconds=0,this.enableClock(!0),this.updateClock(),i.setClass("Completed","hide",!0)}timeStr(t){let e=Math.trunc(t/60),s=Math.trunc(t%60);if(e>=60){let t=Math.trunc(e/60);return e=Math.trunc(e%60),`${t}:${this.pad2(e)}:${this.pad2(s)}`}return`${e}:${this.pad2(s)}`}updateClock(){let t=Date.now()-this.clockStart,e=this.game.nseconds+Math.trunc(t/1e3);i.gEl("Time").innerText=this.timeStr(e)}enableClock(t){this.clockRunning=t,t?(this.clockStart=Date.now(),this.clockId=setInterval(this.updateClock.bind(this),1e3)):(this.game.nseconds+=Math.trunc((Date.now()-this.clockStart)/1e3),clearInterval(this.clockId))}refreshStats(){if(i.gEl("Game").innerText=this.gameName,i.gEl("Errors").innerText=`${this.game.errors}/3`,i.gEl("Hints").innerText=`${this.game.hints}/3`,null!=this.gmdef.Stats&&null!=this.gmdef.Stats){let t=this.gmdef.Stats.firstDate;""==t?(t="Never!",i.gEl("BestTime").innerText=""):i.gEl("BestTime").innerText=this.timeStr(this.gmdef.Stats.bestTime),i.gEl("FCompleted").innerText=t}}showHelp(){this.showPanels("","help")}showMenu(t){n(`Clk ${t.target.id}`),this.showPanels("","menu")}showRecords(){this.showPanels("UserRecords","menu"),i.gEl("FirstWin").innerText=this.userRecords.numFirsts.toString(),i.gEl("FastestWin").innerText=this.userRecords.numBests.toString()}showStats(t){i.gEl("Diff").innerText=this.categories[t],i.gEl("Cnt").innerText=this.UserStats[t].cCnt,i.gEl("PerfCnt").innerText=this.UserStats[t].pCnt,i.gEl("Strk").innerText=this.UserStats[t].cStrk,i.gEl("PerfStrk").innerText=this.UserStats[t].pStrk,this.showPanels("CatStats","menu")}showCompleted(t){i.gEl("TCompleted").innerText=this.timeStr(this.game.nseconds),t?(i.gEl("Perfect").innerText=""==this.newRecord?`${this.gameID} Perfect Game!`:this.newRecord,i.gEl("PctSlowerHd").innerText="Faster than:",i.gEl("PctSlower").innerText=`${Math.round(this.pctSlower)}%`):(i.gEl("Perfect").innerHTML=`${this.gameID} completed!<br> (${this.game.errors}E ${this.game.hints}H)`,i.gEl("PctSlower").innerText=""),i.gEl("PctErr").innerText=`${Math.round(this.pctMoreErrs)}%`,i.gEl("PctHint").innerText=`${Math.round(this.pctMoreHints)}%`,this.showPanels("Completed","data")}initUIstate(){let t=this.cellSize=21.25;this.resizeApp(),i.setClass("Popup","hide",!0);let e=i.gEl("data");e.style.width=this.XSize*t+"px",e.style.height=this.YSize*t+"px",this.longtouchtimer=0,this.touchduration=500,this.touchZooming=!1,this.touchDist=0,this.touchStartDist=0,this.selX=0,this.selY=0,this.usedFree=!1;let s=e.clientWidth,r=e.clientHeight,n=i.gEl("header").clientHeight,a=window.innerWidth/s,h=(window.innerHeight-n)/r;this.touchZoom=Math.trunc(90*(a<h?a:h)),this.setZoom(this.touchZoom,0,0),i.setClass("Playing","hide",!1)}loadGameDef(t){if(null==t.id||null==t.XSz)return void n(`invalid gmdef ${t} ${t.id}`);this.gmdef=t;const e=["*","","1","2","3","4","5","6","7","8","9"],s={E:0,M:.2,H:.5,X:.8};this.initRand(t.G),this.XSize=t.XSz,this.YSize=t.YSz,this.resetGrid(),this.gameID=t.id;let r="";for(let i=0;i<this.YSize;i++){let a=Array.from(t.st[i]);a.length!=this.XSize&&n(` bad gamedef: row ${i}`),this.grid[i]=[],this.processed[i]=[];for(let n=0;n<this.XSize;n++){this.processed[i][n]=!1;let h=a[n],l=this.grid[i][n]=this.decodeGridVal[h];l>=0?0==l&&this.blanks.push([i,n]):this.mines++;let o=`t${l}`,c=this.gID(i,n),d=e[l+1];1==this.decodeQuest[h]&&this.rand()<=s[t.diff]&&(d="?",o="tQ"),1==this.decodeSecret[h]?(o="grd secret",this.secret++):(o+=" grd cleared",this.cleared++),r+=`<span id="${c}" class="${o}"> ${d} </span>`}r+="<br>"}i.gEl("data").innerHTML=r,this.initCurrGame(),this.initUIstate(),this.refreshStats(),this.showCnts()}nextGame(t){this.currDiff=t,this.initCurrGame();let s=localStorage.getItem("Gcntrs");null==s&&(s='{ "E":0,"M":0,"H":0,"X":0,"D":0 }');let i=JSON.parse(s),r=0;if("D"==t){let s=e()().dayOfYear();if(s<i[t])return void n("Daily game already played");n(`Daily ${e()().format("D-MMM-YYYY")}`),this.gameName=this.Daily[s]}else r=i[t],this.gameName=`${t}${this.pad4(r)}`;i[t]++,localStorage.setItem("Gcntrs",JSON.stringify(i)),this.fetchGameDef(this.gameName),this.showPanels("Playing","data"),this.UserStats.gamesStarted++,localStorage.setItem("UserStats",JSON.stringify(this.UserStats))}async fetchGameDef(t){this.gmdef=await this.getDBObj(t),this.loadGameDef(this.gmdef)}genHint(){if(3==this.game.hints)return void n("out of hints");let t=[];for(let e=0;e<this.YSize;e++)for(let s=0;s<this.XSize;s++){let i=this.evalCell({y:e,x:s},!1);if(null!=i){let r=i.secret.length,n=i.nmines-i.marked;0!=n&&r!=n||t.push({y:e,x:s})}}if(0==t.length)n("No deterministic move!");else{let e=t[Math.trunc(this.rand()*t.length)];this.selCell(e.y,e.x,!0),this.game.hints++,this.refreshStats()}}evalCell(t,e){let s=this.gID(t.y,t.x);if(i.hasClass(s,["secret","marked","exploded"]))return null;let r=this.adjCells(t.y,t.x),n=0,a=[];for(let t of r){let e=this.gID(t.y,t.x);i.hasClass(e,"secret")&&a.push(t),i.hasClass(e,"marked")&&n++}if(0==a.length)return e&&(i.gEl(s).innerText="?"),null;let h=this.grid[t.y][t.x];return{y:t.y,x:t.x,nmines:h,marked:n,secret:a}}minMax(t,e){return[0==t?0:t-1,t==e?e:t+1]}adjCells(t,e){let s=[],[i,r]=this.minMax(e,this.XSize-1),[n,a]=this.minMax(t,this.YSize-1);for(let h=n;h<=a;h++)for(let n=i;n<=r;n++)t==h&&e==n||s.push({y:h,x:n});return s}neighbors(t,e){return[[(t=Number(t))-1,(e=Number(e))-1],[t,e-1],[t+1,e-1],[t-1,e],[t+1,e],[t-1,e+1],[t,e+1],[t+1,e+1]]}gID(t,e){return t<0||t>=this.YSize||e<0||e>=this.XSize?null:"m"+this.pad2(t)+this.pad2(e)}clearSecret(t){i.hasClass(t,"secret")||console.log("SECRET"),i.setClass(t,"secret",!1),this.secret--,this.checkCnt(this.secret,"secret")}clearCell(t,e,s,r){this.addMove(t,e,r);let n=this.gID(t,e),a=this.grid[t][e];this.clearSecret(n),s?(i.setClass(n,"freed",!0),this.freed++,this.checkCnt(this.freed,"freed")):(i.hasClass(n,"cleared")&&console.log("CLEAR"),i.setClass(n,"cleared",!0),this.cleared++,this.checkCnt(this.cleared,"cleared"),"?"==i.gEl(n).innerText?i.setClass(n,a<0?"tm":"tQ",!0):i.setClass(n,a<0?"tm":`t${a}`,!0)),this.showCnts()}explodeCell(t,e,s){this.addMove(t,e,s);let r=this.gID(t,e);this.clearSecret(r),navigator.vibrate([50,50,100]),i.setClass(r,"exploded",!0),this.exploded++,this.game.errors++,3==this.game.errors?this.quitGame():(this.refreshStats(),this.showCnts())}bombCell(t,e){this.addMove(t,e,!1);let s=this.gID(t,e);this.clearSecret(s),i.setClass(s,"bombed",!0),this.bombed++,this.showCnts()}markCell(t,e){this.addMove(t,e,!0);let s=this.gID(t,e);if(i.hasClass(s,"marked"))return i.setClass(s,"marked",!1),this.marked--,this.checkCnt(this.marked,"marked"),i.setClass(s,"secret",!0),this.secret++,this.checkCnt(this.secret,"secret"),this.showCnts(),void this.doGridClick(t,e,!1);i.hasClass(s,"secret")&&(this.clearSecret(s),i.setClass(s,"marked",!0),this.marked++,this.checkCnt(this.marked,"marked"),this.showCnts())}cntGrid(t){let e=0;for(let s=0;s<this.YSize;s++)for(let r=0;r<this.XSize;r++)i.hasClass(this.gID(s,r),t)&&e++,"cleared"==t&&i.hasClass(this.gID(s,r),"processed")&&e++;return e}checkCnt(t,e){this.cntGrid(e)!=t&&(this.errCnt++,1==this.errCnt&&console.log(`chkCnt ${e}`))}showCnts(){let t=0,e=0;for(let s=0;s<this.YSize;s++)for(let r=0;r<this.XSize;r++)i.hasClass(this.gID(s,r),"marked")&&(this.grid[s][r]<0?t++:e++);this.gui.setVal("Mines:",`${this.mines} ${this.exploded}E ${this.marked}M`);let s=0==this.errCnt?"":`${this.errCnt}E`;this.det.setVal("Details:",`${this.mines}* (${this.marked}M ${e}W ${t}R) ${this.exploded}E ${this.bombed}B ${this.cleared}C ${this.freed}F ${this.secret}S ${s}`);for(let t of["secret","marked","cleared","exploded","bombed"])this.checkCnt(this[t],t);0==this.secret&&this.gameOver()}incBin(t){const e=[5,5,5,5,5,5,5,5,5,5,5,5,10,10,10,10,10,10,10,10,10,10,10,10,20,20,20,20,20,20,20,20,20,20,20,20,30,30,30,30,30,30,30,30,30,30,30,30,60,60,60,60,60,60,60,60,60,60,60,60,1e7];let s=this.gmdef.Stats.Bins;if(s.length<e.length)for(let t=s.length;t<e.length;t++)s.push(0);let i=0,r=0;for(let n=0;n<e.length;n++){if(i+=e[n],t<i)return s[n]++,console.log(`${t} into Bins[${n}] ${i-e[n]}..${i}`),r;r+=s[n]}return r}quitGame(){this.enableClock(!1),this.UserStats[this.currDiff].cStrk=0,localStorage.setItem("UserStats",JSON.stringify(this.UserStats)),this.showPanels("Playing","menu")}gameOver(){if(this.PlayTest)return;if(this.gameisover)return;this.gameisover=!0,this.enableClock(!1),0!=this.errCnt&&console.log(`${this.errCnt} errs`),navigator.vibrate([100,50,100,50,200]);let t=this.gmdef.Stats,s=this.game.errors,i=this.game.hints,r=this.game.nseconds,n=0==s&&0==i;this.UserStats[this.currDiff].cCnt++,this.UserStats[this.currDiff].cStrk++,t.completeCnt++,t.Cnt[s][i]++;let a=0;for(let e=s+1;e<3;e++)for(let s=0;s<3;s++)a+=t.Cnt[e][s];this.pctMoreErrs=100*a/t.completeCnt;let h=0;for(let e=i+1;e<3;e++)for(let s=0;s<3;s++)h+=t.Cnt[s][e];this.pctMoreHints=100*h/t.completeCnt;let l="";if(this.newRecord="",n){t.perfectCnt++,""==t.firstDate?(t.firstDate=e()().format("YYYY-MMM-DD"),t.bestTime=r,t.bestUsers=[this.userID],this.userRecords.numFirsts++,this.userRecords.numBests++,this.newRecord=`First to perfectly complete ${this.gameID}!`):r<t.bestTime&&(l=t.bestUsers[t.bestUsers.length-1],t.bestTime=r,t.bestUsers.push(this.userID),this.userRecords.numBests++,this.newRecord=`New best time for ${this.gameID}!`),this.UserStats[this.currDiff].pCnt++,this.UserStats[this.currDiff].pStrk++;let s=this.incBin(r),i=t.Cnt[0][0];this.pctSlower=100*(i-s)/i}else this.UserStats[this.currDiff].pStrk=0;this.showCompleted(n),this.setDBObj(this.gameID,this.gmdef),localStorage.setItem("UserStats",JSON.stringify(this.UserStats)),""!=this.newRecord&&(this.setDBObj(this.userID,this.userRecords),""!=l&&this.decrBests(l))}async getDBObj(t,e){let s=e;try{let e=await this.bucket.get(t);s=JSON.parse(e)}catch(s){console.log("getDBObj: setting default"),this.setDBObj(t,e)}return s}async setDBObj(t,e){await this.bucket.set(t,JSON.stringify(e))}async decrBests(t){let e=await this.getDBObj(t);e.numBests--,this.setDBObj(t,e)}showGames(t){if(t.stopPropagation(),!i.hasClass("Popup","hide"))return void i.setClass("Popup","hide",!0);let s=Number(localStorage.getItem("nGames")),r="",n="",a="";for(let t=0;t<s;t++){let s,i=localStorage.getItem(`G${t}`);try{s=JSON.parse(i)}catch{localStorage.removeItem(`G${t}`)}if(null!=s){let t=e()(s.start),i=t.format("D-MMM-YY");i==a&&s.unm==n||(a=i,n=s.unm,r+=`${a} ${n}: <br>`);let h=e()(s.end);r+=`  ${t.format("H:mm")} ${s.name} ${h.diff(t,"minute",!0).toFixed(1)}m  &nbsp;&nbsp; Score:${s.score} <br>`}}if(this.touchHist){let t=this.touchHist;r=`pS:${t.panStartPt.x},${t.panStartPt.y} <br>`,r+=`tS:${t.touchStartPt.x},${t.touchStartPt.y} <br>`,r+=`sD:${t.touchStartDist} Z:${t.touchStartZoom} <br>`;for(let e of t.updt)r+=` zm:${e.zm} dx:${e.dx} dy:${e.dy} <br>`}i.gEl("Popup").innerHTML=r,i.setClass("Popup","hide",!1)}gridClick(t){if(i.setClass("Popup","hide",!0),this.clearSel(),this.gameIsOver)return;let e=t.target;if(!e.id.startsWith("m")||5!=e.id.length)return;let s=Number(e.id.substr(1,2)),r=Number(e.id.substr(3,4));0!=t.button?(this.markCell(s,r),t.preventDefault()):this.doGridClick(s,r,!1)}doGridClick(t,s,r){let n=this.gID(t,s);i.hasClass(n,"secret")&&!this.gameIsOver&&(null==this.game.start&&(this.game.start=e()().format("YYYY-MM-DD HH:mm:ss"),this.game.nMoves=0),this.game.nMoves++,this.grid[t][s]<0?this.dbg.getVal("PropExp")?this.explodeStep(t,s,!0):i.hasClass(n,"exploded")||this.explodeCell(t,s,!0):(this.clearCell(t,s,r,!0),0==this.grid[t][s]&&this.spreadClear(t,s,r),this.showCnts()))}spreadClear(t,e,s){let r=this.neighbors(t,e);for(;r.length>0;){let[t,e]=r.pop(),n=this.gID(t,e);if(this.grid[t][e]>=0&&i.gEl(n).classList.contains("secret")&&(this.clearCell(t,e,s,!1),0==this.grid[t][e])){let s=this.neighbors(t,e);r=r.concat(s)}}}explodeStep(t,e,s){let r=this.gID(t,e);if(i.hasClass(r,"exploded"))return;i.setClass(r,"exploding",!0),this.explodeCell(t,e,s);let n=this.neighbors(t,e);for(let[t,e]of n){let s=this.gID(t,e);if(null!=s&&i.hasClass(s,"secret")){let r=this.grid[t][e];(!i.hasClass(s,"marked")||r>=0)&&(r<0?setTimeout(this.explodeStep.bind(this,t,e,!1),300):this.bombCell(t,e))}}setTimeout(i.setClass(r,"exploding",!1),2500)}touchmove(t){if(2==t.touches.length){this.touchHist=!1;let e=this.touchHist,s=t.touches.item(0),r=t.touches.item(1);this.touchPt={x:(s.clientX+r.clientX)/2,y:(s.clientY+r.clientY)/2};let n=s.clientX-r.clientX,a=s.clientY-r.clientY;this.touchDist=Math.round(Math.sqrt(n*n+a*a));let h=i.gEl("data");if(null==this.touchZoom&&(this.touchZoom=100),0==this.touchStartDist){h.getBoundingClientRect();let t=h.style.left,s=h.style.top;if(this.panStartPt={x:Number(t.replace("px","")),y:Number(s.replace("px",""))},this.touchStartPt={x:this.touchPt.x,y:this.touchPt.y},this.touchStartDist=this.touchDist,this.touchStartZoom=this.touchZoom,e){for(let t of["panStartPt","touchStartPt","touchStartDist","touchStartZoom"])e[t]=this[t];e.updt=[]}}this.touchZoom=Math.trunc(this.touchStartZoom*(this.touchDist/this.touchStartDist));let l=Math.trunc(this.touchPt.x-this.touchStartPt.x),o=Math.trunc(this.touchPt.y-this.touchStartPt.y);e&&e.updt&&e.updt.push({zm:this.touchZoom,dy:this.panStartPt.y+o,dx:this.panStartPt.x+l}),this.setZoom(this.touchZoom,this.panStartPt.y+o,this.panStartPt.x+l)}}touchstart(t){this.clearSel(),this.clearTouch(),t.touches.length>1?(this.touchZooming=!0,t.preventDefault()):this.longtouchtimer=setTimeout(this.onlongtouch.bind(this,t),this.touchduration)}clearTouch(){0!=this.longtouchtimer&&(clearTimeout(this.longtouchtimer),this.longtouchtimer=0)}touchend(t){if(this.clearTouch(),this.touchZooming)return void(0==t.touches.length&&(this.touchZooming=!1,this.touchStartDist=0));let e=t.target;if(!e.id.startsWith("m")||5!=e.id.length)return;t.preventDefault();let s=Number(e.id.substr(1,2)),i=Number(e.id.substr(3,4));this.doGridClick(s,i,!1)}onlongtouch(t){this.longtouchtimer=0;let e=t.target;if(!e.id.startsWith("m")||5!=e.id.length)return;if(!i.hasClass(e,"secret")&&!i.hasClass(e,"marked"))return;let s=Number(e.id.substr(1,2)),r=Number(e.id.substr(3,4));navigator.vibrate(60),this.markCell(s,r),t.preventDefault()}updatePos(){let t=this.dbg.getVal("zm:"),e=this.dbg.getVal("dx:"),s=this.dbg.getVal("dy:");this.setZoom(t,s,e)}setZoom(t,e,s){t=Number(t),e=Number(e),s=Number(s);let r=i.gEl("data"),a=r.clientWidth,h=r.clientHeight,l={x:100*this.windowW/t,y:100*this.windowH/t-this.headerH},o=l.x-1.2*a-20,c=l.y-1.2*h-20;this.dbg.getVal("TM")&&n(` [${Math.round(l.x)}->${Math.round(o)}, ${Math.round(l.y)}->${Math.round(c)}]`),e=l.y<h?Math.round(this.clip(e,c,20)):10,s=l.x<a?Math.round(this.clip(s,o,20)):10,r.style.zoom=`${t}%`,r.style.top=`${e}px`,r.style.left=`${s}px`;let d=i.gEl("header"),u=Math.round(d.getBoundingClientRect().width),m=Math.round(r.getBoundingClientRect().width),g=Math.round(100*m/u);g<100&&(g=100),d.style.zoom=`${g}%`}keydown(t){let e=this.selY,s=this.selX;switch(t.key){case"*":t.ctrlKey&&t.altKey&&i.setClass("guiG0","hide");break;case"ArrowUp":case"i":return void this.selCell(this.clipY(e-1),s);case"ArrowDown":case"k":return void this.selCell(this.clipY(e+1),s);case"ArrowLeft":case"j":return void this.selCell(e,this.clipX(s-1));case"ArrowRight":case"l":return void this.selCell(e,this.clipX(s+1));case"s":case"r":return;case"m":return void this.markCell(e,s);case" ":return void this.doGridClick(e,s,!1)}}clearSel(){null!=this.selY&&null!=this.selX&&i.setClass(this.gID(this.selY,this.selX),["sel","hint"],!1)}selCell(t,e,s){this.clearSel(),this.selY=t,this.selX=e,i.setClass(this.gID(this.selY,this.selX),s?"hint":"sel",!0)}play(t){null==t&&(t=10),this.game.unm="Auto",this.toDo=[];for(let t=0;t<this.YSize;t++)for(let e=0;e<this.XSize;e++){let s=this.gID(t,e);i.hasClass(s,["cleared","freed","exploded","bombed"])&&(0==this.grid[t][e]?this.markProcessed(t,e):this.toDo.push({y:t,x:e}))}this.cntSinceChg=0,this.playStep(t)}playStep(t){for(;this.toDo.length>0&&this.cntSinceChg<3*this.toDo.length;){let e=this.toDo.pop(),s=this.evalCell(e,!0);if(null!=s)return n(`L${this.toDo.length} C${this.cntSinceChg} [${s.y},${s.x}] ${s.nmines}M ${s.marked}M ${s.secret.length}S`),this.selCell(e.y,e.x),this.playCell(s)?this.cntSinceChg=0:(this.toDo.unshift(s),this.cntSinceChg++),void(t>0?setTimeout(this.playStep.bind(this,t),t):this.playStep(t))}n(`Play stopped: L${this.toDo.length} C${this.cntSinceChg}`)}markProcessed(t,e){let s=null==e?t:this.gID(t,e);i.hasClass(s,"bombed")?i.setClass(s,"procbombed",!0):i.setClass(s,"processed",!0),i.setClass(s,["cleared","freed","bombed","tm","t0","t1","t2","t3","t4","t5","t6","t7","t8"],!1)}playCell(t){t.nmines;let e=t.secret.length,s=t.nmines-t.marked;if(s>0&&e!=s)return!1;this.markProcessed(t.y,t.x),this.processed[t.y][t.x]=!0;for(let e of t.secret)this.gID(e.y,e.x),this.playChanged=!0,0==s?(this.clearCell(e.y,e.x,!1),this.toDo.push({y:e.y,x:e.x})):this.markCell(e.y,e.x);return!0}unplayLast(){for(;this.gamesteps.length>0;){let t=this.gamesteps.pop();if(this.unplay(t.y,t.x),t.user)return void this.selCell(t.y,t.x)}}addMove(t,e,s){this.gamesteps.push({x:e,y:t,user:s})}unplay(t,e){this.selCell(t,e);let s=this.gID(t,e);for(let t of["cleared","freed","marked","exploded","bombed","tm","t0","t1","t2","t3","t4","t5","t6","t7","t8"])i.hasClass(s,t)&&(i.setClass(s,t,!1),"t"!=t.charAt(0)&&this[t]--);i.setClass(s,"secret",!0),this.secret++,this.showCnts()}randSafeClick(){for(;this.blanks.length>0;){let t=Math.floor(this.rand()*this.blanks.length),[e,s]=this.blanks[t];if(i.hasClass(this.gID(e,s),"secret")){this.safeClicks.push([e,s]),this.doGridClick(e,s,this.usedFree);for(let t=this.blanks.length-1;t>=0;t--)[e,s]=this.blanks[t],i.hasClass(this.gID(e,s),["cleared","freed"])&&this.blanks.splice(t,1);return this.usedFree=!0,!0}}return n("No more blanks!"),!1}genGame(t,e){let s=`CF_Gm${t}`;this.gameName=`CF_Gm${t}-${e}`,this.gameNum=t,this.XSize=this.gui.getVal("X"),this.YSize=this.gui.getVal("Y"),this.Density=this.gui.getVal("Mine%")/100,this.initCurrGame(),this.initRand(s),this.initUIstate(),this.fillField(this.Density);for(let t=0;t<this.numSafe;t++)this.usedFree=!1,this.randSafeClick();this.showCnts();for(let t=0;t<e;t++)this.randSafeClick()}fillField(t){const e=["*","","1","2","3","4","5","6","7","8","9"];let s=this.XSize,r=this.YSize;this.resetGrid();for(let e=0;e<r;e++){this.grid[e]=[],this.processed[e]=[];for(let i=0;i<s;i++)this.processed[e][i]=!1,this.rand()<t?this.grid[e][i]=-1:this.grid[e][i]=0}for(let t=0;t<r;t++)for(let e=0;e<s;e++)if(this.grid[t][e]>=0)for(let s=t-1;s<t+2;s++)for(let i=e-1;i<e+2;i++)-1==this.grid[s][i]&&this.grid[t][e]++;let n="";this.secret=s*r;for(let t=0;t<r;t++){for(let i=0;i<s;i++){let s=this.grid[t][i]+1,r=this.gID(t,i);this.grid[t][i]<0&&this.mines++,0==this.grid[t][i]&&this.blanks.push([t,i]),n+=`<span id="${r}" class="grd secret"> ${e[s]} </span>`}n+="<br>"}i.gEl("data").innerHTML=n}findWinnable(){this.showPanels("Playing","data");let t=Number(this.mng.getVal("GmStart")),e=t+Number(this.mng.getVal("Batch"));this.mng.setVal("GmStart",e),setTimeout(async function s(){this.maxGms.seed=t,await this.evalGame(t),t++,t<e&&setTimeout(s.bind(this),100)}.bind(this),100)}evalGame(t){this.genGame(t,0);let e=0;for(;this.randSafeClick();)e++;let s=-1;for(let i=e;i>=0&&(this.genGame(t,i),this.PlayTest=!0,this.play(0),this.PlayTest=!1,0==this.secret);i--)s=i;s<0?(n(`Game ${t}-${e} non-winnable`),t>this.maxunwinnable&&(this.maxunwinnable=t)):(this.calcQuest(t,s),n(`Game ${t}-${s} is winnable`))}calcQuest(t,e){this.genGame(t,e),this.PlayTest=!0,this.play(0),this.clearSel(),this.PlayTest=!1,this.quests=[];for(let t=0;t<this.YSize;t++)for(let e=0;e<this.XSize;e++){let s=this.gID(t,e);"?"==i.gEl(s).innerText&&this.quests.push([t,e])}this.genGame(t,e);for(let t of this.quests)i.gEl(this.gID(t[0],t[1])).innerText="?";this.saveGame()}gameState(){let t=[],e=Array.from(this.gridEncode);for(let s=0;s<this.YSize;s++){let r="";for(let t=0;t<this.XSize;t++){let n=this.grid[s][t],a=this.gID(s,t),h=n+1;"?"==i.gEl(a).innerText.trim()&&(h+=10),i.hasClass(a,"secret")&&(h+=20),r+=e[h]}t.push(r)}return t}saveGame(){let t={id:this.gameID,G:this.gameName,GNum:this.gameNum,nS:this.secret,nQ:this.quests.length,XSz:this.XSize,YSz:this.YSize,st:this.gameState(),Stats:{bestTime:this.game.nseconds,bestUsers:[],firstDate:"",Bins:[],completeCnt:0,perfectCnt:0,Cnt:[[0,0,0],[0,0,0],[0,0,0]]}};const e=[[100,"E"],[200,"M"],[262,"H"],[1e3,"X"]];if(this.XSize*this.YSize<400)t.diff="E";else for(let s of e)if(t.nS<=s[0]){t.diff=s[1];break}let s=this.maxGms[t.diff];t.id=`${t.diff}${this.pad4(s)}`,this.maxGms[t.diff]++,this.setGameDB(t),n(`Saved ${t.id}`),console.log(`Saved ${t.id}`),this.loadGameDef(t)}async setGameDB(t){await this.bucket.set(t.id,JSON.stringify(t)),await this.bucket.set("maxGms",JSON.stringify(this.maxGms))}}new b("ClearField  Jul2023.01")})()})();
//# sourceMappingURL=bundle.b652992af13b0696e359.js.map